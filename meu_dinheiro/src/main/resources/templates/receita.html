<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{base_template :: baseHead (pageTitle='Receitas Mensais')}"></head>
<body>
<!-- Cabeçalho -->
<header th:replace="~{base_template :: baseHeaderPage}"></header>

<!-- Conteúdo Principal -->
<div th:replace="~{base_template :: content(mainTitle='Receitas Mensais', subTitle='Gerencie suas receitas financeiras por período.')}">
    <!-- Inserir conteúdo personalizado dentro do div.content -->
    <div th:insert="~{this :: #contentFragment}"></div>
</div>

<!-- Rodapé -->
<footer th:replace="~{base_template :: baseFooter}"></footer>

<!-- Fragmento de Conteúdo Personalizado -->
<div th:fragment="contentFragment" class="content">
    <!-- Formulário para Criar Nova Receita -->
    <div class="form-section">
        <h3>Adicionar Nova Receita</h3>
        <form id="createReceitaForm" onsubmit="submitForm(event)" class="form-container">
            <div class="form-group">
                <label for="descricao">Descrição:</label>
                <input type="text" name="descricao" id="descricao" required class="form-input" />
            </div>
            <div class="form-group">
                <label for="valor">Valor:</label>
                <input type="number" name="valor" id="valor" step="0.01" required class="form-input" />
            </div>
            <div class="form-group">
                <label for="categoriaId">Categoria:</label>
                <select name="categoriaId" id="categoriaId" required class="form-input">
                    <option value="">Selecione uma categoria</option>
                    <option th:each="categoria : ${categorias}" th:value="${categoria.id}" th:text="${categoria.nome}"></option>
                </select>
            </div>
            <div class="form-group">
                <label for="data">Data (yyyy-MM):</label>
                <input type="text" name="data" id="data" required pattern="\d{4}-\d{2}" class="form-input" />
            </div>
            <button type="submit" class="btn-submit">Salvar Nova Receita</button>
        </form>
    </div>

    <!-- Lista de Receitas -->
    <div class="table-section">
        <h3>Lista de Receitas</h3>
        <table class="report-table">
            <thead>
            <tr>
                <th>Descrição</th>
                <th>Valor</th>
                <th>Categoria</th>
                <th>Data</th>
                <th>Ações</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="receita : ${receitas}">
                <td th:text="${receita.descricao}">N/A</td>
                <td><input type="number" name="valor" th:value="${receita.valor}" step="0.01" class="table-input" /></td>
                <td th:text="${receita.categoria != null ? receita.categoria.nome : 'Sem categoria'}" th:attr="data-categoria-id=${receita.categoria != null ? receita.categoria.id : null}">N/A</td>
                <td><input type="text" name="data" th:value="${receita.data}" pattern="\d{4}-\d{2}" class="table-input" /></td>
                <td>
                    <button th:onclick="'updateReceita(' + ${receita.id} + ', event)'" class="btn-action">Atualizar</button>
                    <button th:onclick="'deleteReceita(' + ${receita.id} + ', event)'" class="btn-delete">Deletar</button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Botão para Atualizar para o Mês Atual -->
    <p><a th:href="@{/receita(data=${#dates.format(#dates.createNow(), 'yyyy-MM')})}" class="btn-link">Atualizar para o Mês Atual</a></p>
</div>

<!-- JavaScript -->
<script th:inline="javascript">
    // Função para criar uma nova receita
    function submitForm(event) {
        event.preventDefault();
        console.log('Formulário submetido');

        const form = event.target;
        const formData = {
            descricao: form.descricao.value,
            valor: parseFloat(form.valor.value) || 0,
            data: form.data.value,
            categoria: { id: parseInt(form.categoriaId.value) }
        };

        fetch('/api/v1/receita', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
            .then(response => {
                if (!response.ok) throw new Error('Erro ao salvar: ' + response.statusText);
                return response.json();
            })
            .then(data => {
                console.log('Sucesso:', data);
                alert('Receita salva com sucesso!');
                location.reload();
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao salvar a receita: ' + error.message);
            });
    }

    // Função para atualizar uma receita
    function updateReceita(id, event) {
        event.preventDefault();
        const row = event.target.closest('tr');
        const descricao = row.querySelector('td:first-child').textContent;
        const formData = {
            descricao: descricao,
            valor: parseFloat(row.querySelector('input[name="valor"]').value) || 0,
            data: row.querySelector('input[name="data"]').value,
            categoria: { id: /* Use o ID da categoria atual, se disponível */ parseInt(row.querySelector('td:nth-child(3)').getAttribute('data-categoria-id')) || null }
        };

        fetch(`/api/v1/receita/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        })
            .then(response => {
                if (!response.ok) throw new Error('Erro ao atualizar: ' + response.statusText);
                return response.json();
            })
            .then(data => {
                console.log('Atualizado:', data);
                alert('Receita atualizada com sucesso!');
                location.reload();
            })
            .catch(error => {
                console.error('Erro:', error);
                alert('Erro ao atualizar a receita: ' + error.message);
            });
    }

    // Função para deletar uma receita
    function deleteReceita(id, event) {
        event.preventDefault();
        if (confirm('Tem certeza que deseja deletar esta receita?')) {
            fetch(`/api/v1/receita/${id}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => { throw new Error('Erro ao deletar: ' + text); });
                    }
                    alert('Receita deletada com sucesso!');
                    location.reload();
                })
                .catch(error => {
                    console.error('Erro:', error);
                    alert('Erro ao deletar a receita: ' + error.message);
                });
        }
    }

    console.log('Script carregado');
</script>

<!-- Estilos Adicionais -->
<style>
    .form-section, .table-section { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); margin-bottom: 20px; padding: 20px; }
    .form-group { margin-bottom: 15px; }
    .form-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    .btn-submit { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
    .btn-submit:hover { background-color: #45a049; }
    .report-table { border-radius: 8px; overflow: hidden; width: 100%; }
    .table-input { width: 100px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; }
    .btn-action { background-color: #2196F3; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; }
    .btn-action:hover { background-color: #1976D2; }
    .btn-delete { background-color: #f44336; color: white; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; }
    .btn-delete:hover { background-color: #d32f2f; }
    .btn-link { background-color: #9C27B0; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block; }
    .btn-link:hover { background-color: #7B1FA2; }
</style>
</body>
</html>